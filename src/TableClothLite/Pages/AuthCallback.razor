@page "/auth-callback"
@using TableClothLite.Services
@inject OpenRouterAuthService AuthService
@inject OpenAIChatService ChatService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>식탁보 라이트 Preview</PageTitle>

<h3>인증 처리 중입니다.</h3>

@if (_error != null)
{
    <div class="alert alert-danger">
        @_error
    </div>
    <button class="btn btn-primary" @onclick="RetryAuthentication">다시 시도</button>
}

@code {
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        var code = query["code"];
        if (string.IsNullOrEmpty(code))
        {
            _error = "인증 실패: 코드 전달이 되지 않았거나 인증이 도중에 취소되었습니다.";
            return;
        }

        try
        {
            var apiKey = await AuthService.ObtainApiKeyAsync(code);

            // Store API key in local storage
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "openRouterApiKey", apiKey);

            // Navigate to chat
            NavigationManager.NavigateTo("/Chat");
        }
        catch (Exception ex)
        {
            _error = $"인증 오류: {ex.Message}";
        }
    }

    private Task RetryAuthentication()
    {
        return AuthService.StartAuthFlowAsync();
    }
}
